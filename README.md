# Excel to KML Converter

## Описание

Этот проект предназначен для обработки и конвертации данных из Excel-файлов (XLSX) в формат KML, используемый для отображения геопространственных данных в программах, таких как Google Earth, а также для автоматической загрузки этих данных на Яндекс.Карты. Проект автоматизирует преобразование данных о водных объектах, их расположении и характеристиках в удобный картографический вид, а также производит анализ изменений данных между запусками.

**Основные возможности:**

- Обработка Excel-файлов с данными о водных объектах.
- Разделение данных по регионам.
- Сравнение текущих данных с предыдущими версиями и формирование отчетов об изменениях.
- Генерация KML-файлов на основе координат из Excel.
- Автоматическая (или полуавтоматическая) загрузка KML-файлов на Яндекс.Карты с использованием Selenium и `undetected_chromedriver`.

## Структура проекта

```
.
├── pyproject.toml
├── requirements.txt
├── README.md
├── data
│   └── proj4.json
├── docs
│   └── DOCS.md
├── input/
├── logs/
├── output/
├── tests
│   └── unittests.py
└── src
    ├── __init__.py
    ├── config.py
    ├── debug_parser.py
    ├── main.py
    ├── processing.py
    ├── separator.py
    ├── stats.py
    ├── ui.py
    ├── utils.py
    ├── workers.py
    └── xlsx_to_kml
        ├── __init__.py
        ├── anomalies.py
        ├── io_excel.py
        ├── io_kml.py
        ├── models.py
        ├── parsing.py
        ├── pipeline.py
        └── projections.py
```

**Описание файлов и директорий:**

- **`pyproject.toml` / `requirements.txt`**: Конфигурация проекта и зависимости.
- **`src/main.py`**: Основной скрипт с интерактивным меню и параллельной обработкой.
- **`src/processing.py`, `src/workers.py`**: Логика пайплайна и параллельной обработки.
- **`src/utils.py`**: Вспомогательные функции (генерация цвета, сортировка координат, логирование).
- **`src/xlsx_to_kml/`**: Пакет конвертации XLSX→KML:
  - `models.py`: типы данных (`Point`, `ParseResult`, `ConversionResult`, `ParseError`)
  - `parsing.py`: детекторы и парсеры (`parse_dms_coordinates`, `parse_msk_coordinates`, `parse_coordinates`, `process_coordinates`)
  - `projections.py`: загрузка `proj4.json`, `get_transformers` (кэш), `create_transformer`
  - `anomalies.py`: `haversine_distance`, `detect_coordinate_anomalies`
  - `io_excel.py`: поиск заголовков, индексов столбцов
  - `io_kml.py`: создание точек/линий/полигонов KML
  - `pipeline.py`: фасад `create_kml_from_coordinates`, сохранение аномалий
- **`data/`**: Параметры проекций (`proj4.json`).
- **`tests/`**: Юнит-тесты.

## Установка и запуск

1. **Клонирование репозитория:**

    ```bash
    git clone <URL_репозитория>
    cd <название_проекта>
    ```

2. **Установка зависимостей (рекомендуется использовать виртуальное окружение):**

    Перед установкой зависимостей создайте и активируйте виртуальное окружение:

    ```bash
    python -m venv venv
    .\venv\Scripts\activate   # Windows
    ```

    ```bash
    source venv/bin/activate   # Linux/macOS
    ```

    Затем установите зависимости:

    ```bash
    pip install -r requirements.txt
    ```

    Рекомендуется Python 3.9+.

3. **Подготовка данных:**
    - Поместите Excel-файл(ы) для обработки в директорию `input`.
    - Убедитесь, что `data/proj4.json` содержит необходимые проекции.

4. **Запуск:**

    - **Интерактивный режим:**

        ```bash
        python main.py
        ```

        Выберите режим работы:

        - **1 (Разделение и преобразование)**: Полная обработка с разделением входного файла по регионам и преобразованием в KML.
        - **2 (Преобразование одного файла)**: Быстрое преобразование одного XLSX-файла в KML без разделения.
        - **3 (Отладка парсера)**: Интерактивный режим отладки парсера координат.

    - **Разделение на файлы по регионам:**
        - Поместите файл `BigTable.xlsx` в папку `input`.
        - Запустите скрипт `separator.py`

        ```bash
        python separator.py
        ```

    - **Тестирование:**

    ```bash
    # Вариант unittest
    python -m unittest tests/unittests.py

    # или pytest (если установлен)
    pytest -q
    ```

## Компиляция в исполняемый файл (`dist`)

Ниже приведены шаги для сборки переносимого EXE-файла в директорию `dist` c помощью [PyInstaller](https://pyinstaller.org/).

1. **Установка PyInstaller** *(выполняется один раз)*:

    ```bash
    pip install pyinstaller
    ```

2. **Сборка** *(из корня проекта)*:

    ```bash
    pyinstaller main.spec
    ```

После успешной сборки готовый файл `dist/KML_Converter.exe` вместе с подпапками `data/` и `input/` появится в каталоге `dist/`. Запускайте EXE из этой папки или переносите весь каталог на другой компьютер — отдельная установка Python и зависимостей не требуется.

## Оценка качества данных

Программа автоматически анализирует качество обработанных данных и предоставляет детальную статистику по завершении обработки.

### Метрики качества

**Общая оценка качества** рассчитывается по трем основным критериям:

1. **Успешность парсинга координат (50%)** - процент строк, из которых удалось извлечь корректные координаты
2. **Полнота данных (30%)** - процент строк с заполненными обязательными полями и корректными данными  
3. **Согласованность форматов (20%)** - единообразие форматов координат в файле и количество различных типов ошибок

### Проблемные строки

Строка считается проблемной, если:

- Не удалось извлечь корректные координаты из строки
- Произошла ошибка парсинга координат или их формата
- Строка была помещена в файл аномалий (ANO_*.xlsx) из-за проблем с данными

### Статистика обработки

В конце обработки программа выводит:

- **Сводку обработки**: количество обнаруженных регионов, общее количество обработанных объектов (строк), процент успешно обработанных объектов, время обработки
- **Наиболее проблемные файлы** (топ-5): файлы с наибольшим процентом проблемных строк
- **Оценку качества данных**: детальная разбивка по каждому критерию с визуальными индикаторами прогресса (в Rich)
- **Анализ ошибок**: таблица с наиболее частыми типами ошибок парсинга

#### Градация качества

- **90-100**: Отлично - данные высокого качества, минимальные проблемы
- **80-89**: Хорошо - данные приемлемого качества, незначительные проблемы  
- **70-79**: Удовлетворительно - данные требуют внимания, умеренные проблемы
- **60-69**: Плохо - данные с серьезными проблемами, требуют исправления
- **0-59**: Очень плохо - данные критического качества, необходима полная проверка

### Файлы аномалий

При обнаружении проблемных строк создаются файлы аномалий (ANO_*.xlsx), содержащие:

- Номер строки в оригинальном файле
- Идентификатор объекта (№ п/п)
- Причину ошибки
- Исходную строку с координатами

Эти файлы помогают быстро найти и исправить проблемы в исходных данных. Файлы аномалий создается в той же директории, что и соответствующий KML-файл.

## Дополнительные возможности

### Параллельная обработка

Программа поддерживает параллельную обработку файлов, автоматически используя все доступные ядра процессора для ускорения конвертации.

### Интерактивный отладочный парсер

Режим отладки парсера координат позволяет тестировать парсинг координат в интерактивном режиме:

- Автоматический режим (как в основной программе)
- Ручной режим с пользовательской proj4 строкой

### Расширенное логирование

Программа создает два типа лог-файлов:

- **log_*.log**: Все сообщения логирования (DEBUG и выше)
- **errors_warnings_*.log**: Только предупреждения и ошибки (WARNING и выше)

## Логи и отчёты

- **Логи** работы скриптов сохраняются в директории `logs` в файлах вида `log_YYYYMMDD_HHMMSS.log` и `errors_warnings_YYYYMMDD_HHMMSS.log`.
- **Отчёты об изменениях** сохраняются в `output/regions_with_header/changes_history/` в виде файлов с именем региона и меткой времени.
- **Резервные копии** Excel-файлов сохраняются в `input/history/`.
- **Файлы аномалий** сохраняются рядом с соответствующими KML-файлами в директории `output/kml/` с префиксом `ANO_`.
