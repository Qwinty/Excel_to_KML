# Excel to KML Converter

## Описание

Этот проект предназначен для обработки и конвертации данных из Excel-файлов (XLSX) в формат KML, используемый для отображения геопространственных данных в программах, таких как Google Earth, а также для автоматической загрузки этих данных на Яндекс.Карты. Проект автоматизирует преобразование данных о водных объектах, их расположении и характеристиках в удобный картографический вид, а также производит анализ изменений данных между запусками.

**Основные возможности:**

- Обработка Excel-файлов с данными о водных объектах.
- Разделение данных по регионам.
- Сравнение текущих данных с предыдущими версиями и формирование отчетов об изменениях.
- Генерация KML-файлов на основе координат из Excel.
- Автоматическая (или полуавтоматическая) загрузка KML-файлов на Яндекс.Карты с использованием Selenium и `undetected_chromedriver`.

## Структура проекта

```
.
├── .gitignore
├── main.py
├── requirements.txt
├── separate_into_files.py
├── unittests.py
├── utils.py
├── xlsx_to_kml.py
├── data
│   ├── proj4.json
│   └── proj4.txt
├── input
│   └── Объекты.xlsx
├── logs
│   ├── separate_20241106_175127.log
│   └── ...
└── map_uploader
    └── uploader.py
```

**Описание файлов и директорий:**

- **`.gitignore`**: Файлы и директории, игнорируемые Git.
- **`main.py`**: Основной скрипт для запуска конвертации. Предоставляет выбор между пакетной и одиночной конвертацией.
- **`requirements.txt`**: Список зависимостей проекта.
- **`separate_into_files.py`**: Скрипт для разделения данных по регионам, сравнения изменений и создания отчетов.
- **`unittests.py`**: Юнит-тесты для модуля `xlsx_to_kml.py`.
- **`utils.py`**: Вспомогательные функции (генерация цвета, расчет центроида, сортировка координат, логирование).
- **`xlsx_to_kml.py`**: Модуль для конвертации XLSX в KML, включая парсинг координат и создание KML-структур.
- **`data`**: Файлы с параметрами проекций (`proj4.json`, `proj4.txt`) для преобразования координат.
- **`input`**: Директория для входных Excel-файлов.
- **`logs`**: Директория для лог-файлов.
- **`map_uploader`**: Содержит скрипт `uploader.py` для автоматической загрузки KML на Яндекс.Карты.
- **`output`**: Директория для сохранения результатов. Структура директории описана выше.

## Установка и запуск

1. **Клонирование репозитория:**

    ```bash
    git clone <URL_репозитория>
    cd <название_проекта>
    ```

2. **Установка зависимостей:**

    ```bash
    pip install -r requirements.txt
    ```

    **Зависимости:**

    - `pandas`
    - `openpyxl`
    - `undetected_chromedriver`
    - `pyproj`
    - `simplekml`
    - `selenium`

    Рекомендуется Python 3.9+.

3. **Подготовка данных:**
    - Поместите Excel-файл(ы) для обработки в директорию `input`.
    - Убедитесь, что `data/proj4.json` содержит необходимые проекции.

4. **Запуск:**

    - **Конвертация:**

        ```bash
        python main.py
        ```

        Выберите режим работы:

        - **1 (Batch convert)**: Обработка всех файлов из `output/separated_regions`.
        - **2 (Single convert)**: Обработка одного файла из `input`.

    - **Разделение на файлы по регионам:**
        - Поместите файл `Объекты.xlsx` в папку `input`.
        - Запустите скрипт `separate_into_files.py`

        ```bash
        python separate_into_files.py
        ```

    - **Тестирование:**

        ```bash
        python -m unittest unittests.py
        ```

## Компиляция в исполняемый файл (`dist`)

Ниже приведены шаги для сборки переносимого EXE-файла в директорию `dist` c помощью [PyInstaller](https://pyinstaller.org/).

1. **Установка PyInstaller** *(выполняется один раз)*:

    ```bash
    pip install pyinstaller
    ```

2. **Сборка** *(из корня проекта)*:

    ```bash
    pyinstaller --onefile --name KML_Converter --add-data "data;data" --add-data "input;input" main.py
    ```

    - `--onefile` — создаёт единый исполняемый файл.
    - `--noconsole` — скрывает консольное окно (уберите, если нужен вывод в консоль).
    - `--name` — задаёт имя выходного файла.
    - `--add-data` — добавляет каталоги `data` и `input`, необходимые программе.

    > ⚠️  В Linux/macOS в параметре `--add-data` используйте двоеточие `:` вместо точки с запятой `;`.

После успешной сборки готовый файл `dist/KML_Converter.exe` вместе с подпапками `data/` и `input/` появится в каталоге `dist/`. Запускайте EXE из этой папки или переносите весь каталог на другой компьютер — отдельная установка Python и зависимостей не требуется.

## Логи и отчёты

- **Логи** работы скриптов сохраняются в директории `logs` в файлах вида `separate_YYYYMMDD_HHMMSS.log`.
- **Отчёты об изменениях** сохраняются в `output/regions_with_header/changes_history/` в виде файлов с именем региона и меткой времени.
- **Резервные копии** Excel-файлов сохраняются в `input/history/`.
