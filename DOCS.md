# **Excel to KML Converter: Проект для обработки и визуализации данных о водных объектах**

## 1. Общее описание проекта

Проект предназначен для решения следующих задач:

-   **Обработки Excel-файлов**, содержащих данные о водных объектах, их расположении и различных характеристиках.
-   **Разделения данных по регионам**, сравнения изменений с предыдущими версиями и формирования отчетов об изменениях.
-   **Генерации KML-файлов** на основе распознанных координат для последующей визуализации данных на карте (в том числе в сервисе Яндекс.Карты).
-   **Автоматической (или полуавтоматической) загрузки** сформированных KML-файлов в Яндекс.Карты посредством Selenium (через `undetected_chromedriver`).

Таким образом, проект автоматизирует преобразование входных Excel-данных о водных объектах в удобный картографический вид, включая анализ изменений и экспорт на карту.

## 2. Структура проекта

```
.
│   .gitignore
│   main.py
│   requirements.txt
│   separate_into_files.py
│   unittests.py
│   utils.py
│   xlsx_to_kml.py
│   ...
│
├───data
│       proj4.json
│       proj4.txt
│
├───input
│       Объекты.xlsx
│       ...
│
├───logs
│       ...
│
└───map_uploader
        uploader.py
        ...
```

**Подробное описание основных файлов и директорий:**

-   **`main.py`**:
    -   Точка входа при запуске проекта из командной строки.
    -   Содержит логику интерактивного выбора режима работы (**Batch convert** или **Single convert**).
    -   При выборе **Single convert** запускает обработку файла(ов) из указанной директории. При выборе **Batch convert** — предлагает выбрать Excel-файл в папке `input/` и выполнить нужные действия, включая генерацию KML.

-   **`separate_into_files.py`**:
    -   Содержит основной класс `WaterObjectsProcessor`, который:
        -   Загружает Excel-файл.
        -   Разделяет данные по регионам.
        -   Сравнивает текущую и предыдущую версию файлов.
        -   Формирует отчёты об изменениях.
        -   Форматирует выходные Excel-файлы.
        -   Сохраняет процессы обработки в логах и хранит «историю» изменений.

-   **`unittests.py`**:
    -   Модуль с примером тестов для функции `parse_coordinates()`, которая парсит координаты из заданного текстового формата в более структурированный вид.
    -   Может расширяться дополнительными тестами по мере увеличения функционала.

-   **`utils.py`**:
    -   Содержит вспомогательные функции, включая:
        -   `generate_random_color()`: генерирует случайный цвет для KML.
        -   `calculate_centroid()` / `calculate_angle()` / `sort_coordinates()`: помогают сортировать координаты и вычислять «центроид».
        -   `setup_logging()`: настройка системы логирования (создание директории `logs`, формирование файла лога и др.).

-   **`xlsx_to_kml.py`**:
    -   Модуль с функциями для конвертации Excel-данных в формат KML.
    -   Включает логику парсинга координат (`parse_coordinates()`), создания объектов KML (точек, линий, полигонов) с помощью библиотеки `simplekml`, а также работу с проекциями через `pyproj` (и `proj4.json` в папке `data`).

-   **`map_uploader/uploader.py`**:
    -   Скрипт для автоматизации работы с Яндекс.Картами, использует Selenium (через `undetected_chromedriver`).
    -   Открывает сессию браузера, при необходимости загружает сохранённые cookie-файлы, переходит в «Яндекс.Конструктор карт» и позволяет загружать KML-файлы.
    -   Позволяет сохранить обновлённые cookie после сессии, если требуется.

-   **`data/`**:
    -   Содержит файлы с параметрами проекций (`proj4.json`, `proj4.txt`) — для корректных преобразований координат в WGS84.

-   **`input/`**:
    -   Директория с входными Excel-файлами для обработки.
    -   Могут находиться, например:
        -   Файлы со списком водных объектов.
        -   Файлы истории.
        -   JSON-файл `processing_history.json` и папка `history` (куда копируются предыдущие версии).

-   **`logs/`**:
    -   Директория с логами выполнения:
        -   Автоматически формируемые логи, например `separate_20241106_175127.log` и др.

-   **`requirements.txt`**:
    -   Перечень зависимостей проекта (библиотеки Python).
    -   Например, `openpyxl`, `pandas`, `undetected_chromedriver`, `pyproj`, `simplekml` и т.д.

## 3. Системные и программные зависимости

Необходимо установить зависимости из `requirements.txt`. Пример (может отличаться от реального содержимого):

```
pandas==X.X.X
openpyxl==X.X.X
undetected-chromedriver==X.X.X
pyproj==X.X.X
simplekml==X.X.X
selenium==X.X.X
```

Также рекомендуется:

-   **Python 3.9+** (с учётом используемых типов и импортов)
-   **ОС Windows, Linux или macOS** (в зависимости от необходимости использовать Selenium/Chrome).

Кроме Python-зависимостей, для корректной работы `pyproj` и прочих утилит может потребоваться установка системных библиотек (например, `proj` на Linux или соответствующие пакеты под Windows).

## 4. Подробности реализации

### 4.1 Модуль `main.py`

**Функция `main()`**

-   Выводит меню для выбора режима работы (batch/одиночный).
-   В случае **Batch** (пункт "1"):
    -   Вызывает `choose_file()`, которая отображает список Excel-файлов в `input/` и ждёт номера файла от пользователя.
    -   Загружает Excel через `openpyxl.load_workbook`, а затем формирует KML.
-   В случае **Single** (пункт "2"):
    -   Запускает `batch_convert("output/separated_regions")`, обрабатывая все `.xlsx` в указанной директории.

### 4.2 Класс `WaterObjectsProcessor` (файл `separate_into_files.py`)

Основная логика разделения данных по регионам и анализа изменений:

-   **`process_file()`** – точка входа в обработку:
    -   Загружает историю предыдущих обработок из `input/processing_history.json` (если есть).
    -   Читает текущий Excel, парсит листы, разделяет их по регионам (см. `get_regions_data()`).
    -   Сохраняет объекты без координат в отдельную "сводку" (метод `save_objects_without_coordinates()`).
    -   Если в истории сохранён путь к предыдущему файлу, загружает и сравнивает его содержимое с текущим (метод `compare_regions()`).
    -   Для изменённых или новых регионов создаёт отдельные Excel-файлы, сохраняет отчёты об изменениях (метод `save_changes_report()`) и применяет форматирование (метод `apply_formatting()`).
    -   Обновляет историю и сохраняет копию текущего файла в папку `input/history/`.
-   **`get_regions_data()`** – разбивает датафрейм на части по регионам, ориентируясь на наличие определённых строк (например, где встречается слово "область").
-   **`compare_regions()`** – находит новые, удалённые и изменённые объекты, сравнивая текущие и предыдущие версии региона.
-   **`apply_formatting()`** – задаёт ширину столбцов, объединяет ячейки для заголовков, включает перенос текста и центрирование. Использует `openpyxl`.
-   **`save_changes_report()`** – формирует txt-файл со списком новых, удалённых и изменённых объектов по каждому региону.

### 4.3 Модуль `xlsx_to_kml.py`

-   **`parse_coordinates(coord_str: str)`**
    -   Извлекает из строки координаты в форматах «градусы, минуты, секунды», а также (при необходимости) в проекциях, описанных в `proj4.json`.
    -   Возвращает список кортежей (имя_точки, долгота, широта).
-   **`create_kml_from_coordinates(sheet, output_file, sort_numbers=None)`**
    -   По листу Excel ищет столбцы с названием, координатами, прочими полями.
    -   Находит все координаты и в зависимости от их количества создаёт либо полигон, либо линию, либо набор точек в KML-файле.
    -   Использует `simplekml` для упрощённого формирования KML. При необходимости сортирует координаты (если их нужно соединять в определённом порядке).

### 4.4 Модуль `unittests.py`

-   Тесты показывают пример ожидаемого результата для парсинга координат с различными форматами входных данных.
-   Запускаются стандартным способом:

    ```bash
    python -m unittest unittests.py
    ```

### 4.5 Модуль `utils.py`

-   Функции сортировки и вычисления центроида – если необходимо упорядочить точки полигона по окружности, используется приблизительный алгоритм (через вычисление угла относительно центроида).
-   `setup_logging()` – при каждом запуске создаёт лог-файл (в каталоге `logs`) с префиксом `separate_YYYYMMDD_HHMMSS.log`.

### 4.6 Модуль `map_uploader/uploader.py`

-   Использует библиотеку `undetected_chromedriver` для обхода возможных блокировок Selenium.
-   Открывает браузер, загружает (при наличии) cookies (`yandex_cookies.pkl`), переходит на `https://yandex.ru/map-constructor/` и позволяет загрузить KML-файл.
-   При желании можно сохранять обновлённые cookies для будущих запусков.